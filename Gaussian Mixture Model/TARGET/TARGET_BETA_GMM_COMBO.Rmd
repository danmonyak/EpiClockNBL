---
title: "TARGET_BETA_GMM_COMBO"
author: "Graham Gumbert"
date: "2025-01-17"
output:
  pdf_document: default
  html_document: default
params:
  cloud_path: "~/Library/CloudStorage/Box-Box/PROJECT 06023: MolClocks/Neuroblastoma_Paper/Datasets/TARGET/"
  save_file: "~/Library/CloudStorage/Box-Box/PROJECT 06023: MolClocks/Neuroblastoma_Paper/Gaussian Mixture Model/"
  beta_vals_file: NBL.methyl.antiNonIterClustNotStuck_sites.tsv
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

source(
  file.path(
    "~/Documents/GitHub/PanCancerClock/Beta Peak Decomposition/",
    "my_BetaMixture.R"
  )
)

library(rstan)
library(dplyr)
library(ggplot2)
library(gridExtra)
library(bayesplot)
library(VGAM)

rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
```

```{r}
data <- read.table(
  paste0(params$cloud_path, params$beta_vals_file), 
  header = TRUE, sep = "\t"
)

site_ids   <- data[[1]]
tumor_data <- data[, -1]

num_tumors <- ncol(tumor_data)
num_sites  <- nrow(tumor_data)

cat("Number of sites:", num_sites, "\n")
cat("Number of tumors:", num_tumors, "\n")
```

```{r}
stan_code <- "
data {
  int<lower=1> N_data;
  // Use a vector (bounded 0..1) for older Stan version compatibility
  vector<lower=0,upper=1>[N_data] y;
}

parameters {
  simplex[3] psi;
  real<lower=0,upper=0.5> X;
  real<lower=1> N;
}

transformed parameters {
  real mu_left   = X;
  real mu_middle = 0.5;
  real mu_right  = 1 - X;

  real var_left   = X * (1 - X) / N;
  real var_middle = 0.25 / N;
  real var_right  = X * (1 - X) / N;

  real sigma_left   = sqrt(var_left);
  real sigma_middle = sqrt(var_middle);
  real sigma_right  = sqrt(var_right);
}

model {
  // Priors
  psi ~ dirichlet(rep_vector(1.0, 3));
  X ~ beta(1, 4);
  N ~ gamma(2, 0.1);

  // Likelihood
  for (n in 1:N_data) {
    array[3] real lps;
    lps[1] = log(psi[1]) + normal_lpdf(y[n] | mu_left,   sigma_left);
    lps[2] = log(psi[2]) + normal_lpdf(y[n] | mu_middle, sigma_middle);
    lps[3] = log(psi[3]) + normal_lpdf(y[n] | mu_right,  sigma_right);
    target += log_sum_exp(lps);
  }
}
"

sm <- stan_model(model_code = stan_code)
```

```{r}
stan_code_prior <- "
data {
  int<lower=1> N_data;
  array[N_data] real y;
}

parameters {
  simplex[3] psi; // Mixture weights sum to 1
  real<lower=0,upper=0.5> X; // left peak position
  real<lower=1> N; // effective number of alleles
}

transformed parameters {
  // Means of the three Gaussian peaks
  real mu_left = X;
  real mu_right = 1 - X;
  real mu_middle = 0.5;

  // Variances (p*(1-p)/N) for each peak
  real var_left = X*(1-X)/N;
  real var_right = X*(1-X)/N;
  real var_middle = 0.25/N; // 0.5*(1-0.5)=0.25

  // Standard deviations
  real sigma_left = sqrt(var_left);
  real sigma_right = sqrt(var_right);
  real sigma_middle = sqrt(var_middle);
}

model {
  psi ~ dirichlet([5.0, 10.0, 5.0]); // quarter half quarter weighting with tuning for variance
  X ~ beta(1,4);
  N ~ gamma(2, 0.1);

  for (n in 1:N_data) {
    array[3] real lps;
    lps[1] = log(psi[1]) + normal_lpdf(y[n] | mu_left, sigma_left);
    lps[2] = log(psi[2]) + normal_lpdf(y[n] | mu_middle, sigma_middle);
    lps[3] = log(psi[3]) + normal_lpdf(y[n] | mu_right, sigma_right);

    target += log_sum_exp(lps);
  }
}
"

sm_prior <- stan_model(model_code = stan_code_prior)
```

```{r}
# Initialize result lists
results_list <- list()
results_list_prior <- list()
X_gmm_values <- c()
X_prior_values <- c()
X_beta_values <- c()
tumor_names <- c()
```

```{r, message=FALSE, warning=FALSE}
# Loop through tumor data and fit models
for (j in 1:ncol(tumor_data)) {
  tumor_id <- colnames(tumor_data)[j]

  y <- tumor_data[[tumor_id]]
  y <- y[!is.na(y)]
  y <- y[is.finite(y)]
  N_obs <- length(y)

  suppressMessages({
    fit_gmm <- sampling(
      sm,
      data = list(N_data = N_obs, y = y),
      chains = 4,
      iter = 4000,
      warmup = 2000,
      seed = 42,
      control = list(adapt_delta = 0.99, max_treedepth = 15),
      refresh = 0
    )

    fit_prior <- sampling(
      sm_prior,
      data = list(N_data = N_obs, y = y),
      chains = 4,
      iter = 4000,
      warmup = 2000,
      seed = 42,
      control = list(adapt_delta = 0.99, max_treedepth = 15),
      refresh = 0
    )
  })

  # Extract posterior means for regular model
  posterior <- rstan::extract(fit_gmm)
  psi_gmm <- colMeans(posterior$psi)
  X_gmm <- mean(posterior$X)
  N_gmm <- mean(posterior$N)

  # Extract posterior means for prior-biased model
  posterior_prior <- rstan::extract(fit_prior)
  psi_prior <- colMeans(posterior_prior$psi)
  X_prior <- mean(posterior_prior$X)
  N_prior <- mean(posterior_prior$N)

  # Calculate Beta Decomposition X
  beta_fit <- BetaMixture_my(y, K = 3, forever = 1500, debug = FALSE, epsilon = 1e-3)
  alpha_bmm <- beta_fit@mle[1, ]
  beta_bmm <- beta_fit@mle[2, ]
  X_beta <- (alpha_bmm[1] / (alpha_bmm[1] + beta_bmm[1]) +
             (1 - (alpha_bmm[3] / (alpha_bmm[3] + beta_bmm[3])))) / 2

  # Generate GMM Plot
  xgrid <- seq(0, 1, length.out = 200)
  g1 <- psi_gmm[1] * dnorm(xgrid, mean = X_gmm, sd = sqrt(X_gmm * (1 - X_gmm) / N_gmm))
  g2 <- psi_gmm[2] * dnorm(xgrid, mean = 0.5, sd = sqrt(0.25 / N_gmm))
  g3 <- psi_gmm[3] * dnorm(xgrid, mean = 1 - X_gmm, sd = sqrt(X_gmm * (1 - X_gmm) / N_gmm))
  gmm_df <- data.frame(x = xgrid, total = g1 + g2 + g3, comp1 = g1, comp2 = g2, comp3 = g3)

  gmm_plot <- ggplot() +
    geom_histogram(aes(x = y, y = ..density..), bins = 50, fill = "gray80", color = "white") +
    geom_line(data = gmm_df, aes(x = x, y = total), color = "black", size = 1.1) +
    geom_line(data = gmm_df, aes(x = x, y = comp1), color = "red", linetype = 2) +
    geom_line(data = gmm_df, aes(x = x, y = comp2), color = "blue", linetype = 2) +
    geom_line(data = gmm_df, aes(x = x, y = comp3), color = "green", linetype = 2) +
    labs(title = "GMM", tumor_id) +
    theme_minimal()

  # Generate Prior-Biased GMM Plot
  g1_prior <- psi_prior[1] * dnorm(xgrid, mean = X_prior, sd = sqrt(X_prior * (1 - X_prior) / N_prior))
  g2_prior <- psi_prior[2] * dnorm(xgrid, mean = 0.5, sd = sqrt(0.25 / N_prior))
  g3_prior <- psi_prior[3] * dnorm(xgrid, mean = 1 - X_prior, sd = sqrt(X_prior * (1 - X_prior) / N_prior))
  gmm_prior_df <- data.frame(x = xgrid, total = g1_prior + g2_prior + g3_prior,
                             comp1 = g1_prior, comp2 = g2_prior, comp3 = g3_prior)

  gmm_prior_plot <- ggplot() +
    geom_histogram(aes(x = y, y = ..density..), bins = 50, fill = "gray80", color = "white") +
    geom_line(data = gmm_prior_df, aes(x = x, y = total), color = "black", size = 1.1) +
    geom_line(data = gmm_prior_df, aes(x = x, y = comp1), color = "red", linetype = 2) +
    geom_line(data = gmm_prior_df, aes(x = x, y = comp2), color = "blue", linetype = 2) +
    geom_line(data = gmm_prior_df, aes(x = x, y = comp3), color = "green", linetype = 2) +
    labs(title = "GMM Prior") +
    theme_minimal()

  # Generate Beta Decomposition Plot
  phi <- beta_fit@phi
  
  comp1 <- phi[1] * dbeta(xgrid, alpha_bmm[1], beta_bmm[1])
  comp2 <- phi[2] * dbeta(xgrid, alpha_bmm[2], beta_bmm[2])
  comp3 <- phi[3] * dbeta(xgrid, alpha_bmm[3], beta_bmm[3])
  comp_total <- comp1 + comp2 + comp3

  beta_df <- data.frame(
    x      = xgrid,
    comp1  = comp1,
    comp2  = comp2,
    comp3  = comp3,
    total  = comp_total
  )
  beta_plot <- ggplot() +
    geom_histogram(aes(x = y, y = ..density..),
                 bins = 50, fill = "gray80", color = "white") +
    geom_line(data = beta_df, aes(x = x, y = total),
            color = "black", size = 1.1) +
    geom_line(data = beta_df, aes(x = x, y = comp1),
            color = "red", linetype = 2) +
    geom_line(data = beta_df, aes(x = x, y = comp2),
            color = "blue", linetype = 2) +
    geom_line(data = beta_df, aes(x = x, y = comp3),
            color = "green", linetype = 2) +
    labs(title = "Beta Decomp") +
    theme_minimal()

  grid.arrange(gmm_plot, gmm_prior_plot, beta_plot, ncol = 3)

  # Print relevant stats
  table_df <- data.frame(
    Parameter = c("X", "psi[1]", "psi[2]", "psi[3]", "N", "Variance"),
    GMM = c(
      paste0(round(X_gmm, 3), ", ", round(1 - X_gmm, 3)),
      round(psi_gmm[1], 3),
      round(psi_gmm[2], 3),
      round(psi_gmm[3], 3),
      round(N_gmm, 3),
      paste0(round(c(
        X_gmm * (1 - X_gmm) / N_gmm,
        0.25 / N_gmm,
        X_gmm * (1 - X_gmm) / N_gmm
      ), 3), collapse = ", ")
    ),
    GMM_Prior = c(
      paste0(round(X_prior, 3), ", ", round(1 - X_prior, 3)),
      round(psi_prior[1], 3),
      round(psi_prior[2], 3),
      round(psi_prior[3], 3),
      round(N_prior, 3),
      paste0(round(c(
        X_prior * (1 - X_prior) / N_prior,
        0.25 / N_prior,
        X_prior * (1 - X_prior) / N_prior
      ), 3), collapse = ", ")
    ),
    Beta_Decomp = c(
      paste0(round(c(
        alpha_bmm[1] / (alpha_bmm[1] + beta_bmm[1]),
        1 - (alpha_bmm[3] / (alpha_bmm[3] + beta_bmm[3]))
      ), 3), collapse = ", "),
      round(beta_fit@phi[1], 3),
      round(beta_fit@phi[2], 3),
      round(beta_fit@phi[3], 3),
      NA,
      paste0(round(c(
        alpha_bmm[1] * beta_bmm[1] / (
          (alpha_bmm[1] + beta_bmm[1])^2 * (alpha_bmm[1] + beta_bmm[1] + 1)
        ),
        alpha_bmm[2] * beta_bmm[2] / (
          (alpha_bmm[2] + beta_bmm[2])^2 * (alpha_bmm[2] + beta_bmm[2] + 1)
        ),
        alpha_bmm[3] * beta_bmm[3] / (
          (alpha_bmm[3] + beta_bmm[3])^2 * (alpha_bmm[3] + beta_bmm[3] + 1)
        )
      ), 3), collapse = ", ")
    )
  )

  cat("### Tumor:", tumor_id, "\n\n")
  print(knitr::kable(table_df, format = "markdown"))
  cat("\n\n")

  # Store results
  X_gmm_values   <- c(X_gmm_values, X_gmm)
  X_prior_values <- c(X_prior_values, X_prior)
  X_beta_values  <- c(X_beta_values, X_beta)
  tumor_names    <- c(tumor_names, tumor_id)
}

results_df <- data.frame(
  Tumor_Name = tumor_names,
  X_GMM = X_gmm_values,
  X_Prior = X_prior_values,
  X_Beta = X_beta_values
)

diff_gmm_prior  <- results_df$X_GMM - results_df$X_Prior
diff_gmm_beta   <- results_df$X_GMM - results_df$X_Beta
diff_prior_beta <- results_df$X_Prior - results_df$X_Beta

hist_gmm_prior <- ggplot() +
  geom_histogram(aes(x = diff_gmm_prior),
                 bins = 30, fill = "blue", alpha = 0.7) +
  labs(title = "Difference: GMM - Prior",
       x = "Difference", y = "Frequency") +
  theme_minimal()

hist_gmm_beta <- ggplot() +
  geom_histogram(aes(x = diff_gmm_beta),
                 bins = 30, fill = "green", alpha = 0.7) +
  labs(title = "Difference: GMM - Beta",
       x = "Difference", y = "Frequency") +
  theme_minimal()

hist_prior_beta <- ggplot() +
  geom_histogram(aes(x = diff_prior_beta),
                 bins = 30, fill = "red", alpha = 0.7) +
  labs(title = "Difference: Prior - Beta",
       x = "Difference", y = "Frequency") +
  theme_minimal()

scatter_gmm_prior <- ggplot(results_df, aes(x = X_GMM, y = X_Prior)) +
  geom_point(alpha = 0.7) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  labs(title = "GMM vs Prior", x = "X_GMM", y = "X_Prior") +
  theme_minimal()

scatter_gmm_beta <- ggplot(results_df, aes(x = X_GMM, y = X_Beta)) +
  geom_point(alpha = 0.7) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  labs(title = "GMM vs Beta", x = "X_GMM", y = "X_Beta") +
  theme_minimal()

scatter_prior_beta <- ggplot(results_df, aes(x = X_Prior, y = X_Beta)) +
  geom_point(alpha = 0.7) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Prior vs Beta", x = "X_Prior", y = "X_Beta") +
  theme_minimal()

```

```{r histograms, fig.height=9, fig.width=5}
library(gridExtra)
grid.arrange(
  hist_gmm_prior,
  hist_gmm_beta,
  hist_prior_beta,
  ncol = 1
)
```

```{r}
cat("\\newpage")
```

```{r}
grid.arrange(
  scatter_gmm_prior,
  scatter_gmm_beta,
  scatter_prior_beta,
  ncol = 1
)

```

```{r}
pearson_gmm_prior  <- cor(results_df$X_GMM, results_df$X_Prior,  method = "pearson")
spearman_gmm_prior <- cor(results_df$X_GMM, results_df$X_Prior,  method = "spearman")

pearson_gmm_beta   <- cor(results_df$X_GMM, results_df$X_Beta,   method = "pearson")
spearman_gmm_beta  <- cor(results_df$X_GMM, results_df$X_Beta,   method = "spearman")

pearson_prior_beta  <- cor(results_df$X_Prior, results_df$X_Beta, method = "pearson")
spearman_prior_beta <- cor(results_df$X_Prior, results_df$X_Beta, method = "spearman")

cat("\n## Correlation coefficients:\n\n")

cat("**GMM vs Prior**\n")
cat(" - Pearson:",  round(pearson_gmm_prior,  3), "\n")
cat(" - Spearman:", round(spearman_gmm_prior, 3), "\n\n")

cat("**GMM vs Beta**\n")
cat(" - Pearson:",  round(pearson_gmm_beta,   3), "\n")
cat(" - Spearman:", round(spearman_gmm_beta,  3), "\n\n")

cat("**Prior vs Beta**\n")
cat(" - Pearson:",  round(pearson_prior_beta,  3), "\n")
cat(" - Spearman:", round(spearman_prior_beta, 3), "\n\n")

```

```{r}
# Define the output file path
output_file <- file.path(params$save_file, "tumor_X_results.csv")

# Save results to CSV
write.csv(results_df, output_file, row.names = FALSE)

cat("Results saved to:", output_file, "\n")
```