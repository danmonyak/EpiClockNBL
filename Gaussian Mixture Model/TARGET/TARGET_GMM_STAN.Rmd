---
title: "TARGET_GMM_STAN"
author: "Graham Gumbert"
date: "2024-12-20"
output:
  pdf_document: default
  html_document: default
  word_document: default
params:
  cloud_path: "~/Library/CloudStorage/Box-Box/PROJECT 06023: MolClocks/Neuroblastoma_Paper/Datasets/TARGET/"
  beta_vals_file: NBL.methyl.traditional_sites.tsv
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(rstan)
library(dplyr)
library(ggplot2)
library(bayesplot)

rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
```

```{r}
data <- read.table(paste0(params$cloud_path, params$beta_vals_file), 
                   header = TRUE, sep = "\t")

site_ids <- data[[1]]
tumor_data <- data[,-1]

num_tumors <- ncol(tumor_data)
num_sites <- nrow(tumor_data)

cat("Number of sites:", num_sites, "\n")
cat("Number of tumors:", num_tumors, "\n")
```

```{r}
stan_code <- "
data {
  int<lower=1> N_data;
  array[N_data] real y;
}

parameters {
  simplex[3] psi; // Mixture weights sum to 1
  real<lower=0,upper=0.5> X; // left peak position
  real<lower=1> N; // effective number of alleles
}

transformed parameters {
  // Means of the three Gaussian peaks
  real mu_left = X;
  real mu_right = 1 - X;
  real mu_middle = 0.5;

  // Variances (p*(1-p)/N) for each peak
  real var_left = X*(1-X)/N;
  real var_right = X*(1-X)/N;
  real var_middle = 0.25/N; // 0.5*(1-0.5)=0.25

  // Standard deviations
  real sigma_left = sqrt(var_left);
  real sigma_right = sqrt(var_right);
  real sigma_middle = sqrt(var_middle);
}

model {
  psi ~ dirichlet([5.0, 10.0, 5.0]); // quarter half quarter weighting with tuning for variance
  X ~ beta(1,4);
  N ~ gamma(2, 0.1);

  for (n in 1:N_data) {
    array[3] real lps;
    lps[1] = log(psi[1]) + normal_lpdf(y[n] | mu_left, sigma_left);
    lps[2] = log(psi[2]) + normal_lpdf(y[n] | mu_middle, sigma_middle);
    lps[3] = log(psi[3]) + normal_lpdf(y[n] | mu_right, sigma_right);

    target += log_sum_exp(lps);
  }
}

generated quantities {
  real phi = -log1m(2 * X) / 2;
}
"

sm <- stan_model(model_code = stan_code)
```

```{r cache=TRUE, echo = FALSE, results = 'hide'}
# We'll loop through each column and fit the model

results_list <- list()

for (j in 1:ncol(tumor_data)) {
  tumor_id <- colnames(tumor_data)[j]
  y <- tumor_data[[tumor_id]]
  y <- y[!is.na(y)]
  y <- y[is.finite(y)]
  N_obs <- length(y)

  if (N_obs == 0) {
    cat("No valid numeric data for tumor:", tumor_id, "\n")
    next
  }

  # Fit the model
  fit <- sampling(
  object  = sm,
  data    = list(N_data = N_obs, y = y),
  chains  = 4,
  iter    = 4000,
  warmup  = 2000,
  seed    = 42,
  control = list(adapt_delta = 0.99, max_treedepth = 15)
)


  # Store the fit object
  results_list[[tumor_id]] <- fit
}

```

```{r}
tumor_params <- data.frame(
  Tumor  = names(results_list),
  
  psi_1_mean   = NA,
  psi_1_lower  = NA,
  psi_1_upper  = NA,
  psi_2_mean   = NA,
  psi_2_lower  = NA,
  psi_2_upper  = NA,
  psi_3_mean   = NA,
  psi_3_lower  = NA,
  psi_3_upper  = NA,
  
  X_mean       = NA,
  X_lower      = NA,
  X_upper      = NA,
  
  N_mean       = NA,
  N_lower      = NA,
  N_upper      = NA,
  
  phi_mean     = NA,
  phi_lower    = NA,
  phi_upper    = NA,
  
  stringsAsFactors = FALSE
)

for (i in seq_along(results_list)) {
  tumor_id         = names(results_list)[i]
  fit              = results_list[[i]]
  
  if (is.null(fit)) {
    next
  }
  
  posterior_samples <- rstan::extract(fit)
  
  ci <- function(x) {
    c(
      lower = quantile(x, probs = 0.025, na.rm = TRUE),
      upper = quantile(x, probs = 0.975, na.rm = TRUE)
    )
  }
  
  psi_1_vals        <- posterior_samples$psi[, 1]
  psi_2_vals        <- posterior_samples$psi[, 2]
  psi_3_vals        <- posterior_samples$psi[, 3]
  
  psi_1_ci          <- ci(psi_1_vals)
  psi_2_ci          <- ci(psi_2_vals)
  psi_3_ci          <- ci(psi_3_vals)
  
  X_vals            <- posterior_samples$X
  X_ci              <- ci(X_vals)
  
  N_vals            <- posterior_samples$N
  N_ci              <- ci(N_vals)
  
  phi_vals          <- posterior_samples$phi
  phi_ci            <- ci(phi_vals)
  
  tumor_params[i, "psi_1_mean"]  <- mean(psi_1_vals, na.rm = TRUE)
  tumor_params[i, "psi_1_lower"] <- psi_1_ci["lower.2.5%"]
  tumor_params[i, "psi_1_upper"] <- psi_1_ci["upper.97.5%"]
  
  tumor_params[i, "psi_2_mean"]  <- mean(psi_2_vals, na.rm = TRUE)
  tumor_params[i, "psi_2_lower"] <- psi_2_ci["lower.2.5%"]
  tumor_params[i, "psi_2_upper"] <- psi_2_ci["upper.97.5%"]
  
  tumor_params[i, "psi_3_mean"]  <- mean(psi_3_vals, na.rm = TRUE)
  tumor_params[i, "psi_3_lower"] <- psi_3_ci["lower.2.5%"]
  tumor_params[i, "psi_3_upper"] <- psi_3_ci["upper.97.5%"]
  
  tumor_params[i, "X_mean"]      <- mean(X_vals, na.rm = TRUE)
  tumor_params[i, "X_lower"]     <- X_ci["lower.2.5%"]
  tumor_params[i, "X_upper"]     <- X_ci["upper.97.5%"]
  
  tumor_params[i, "N_mean"]      <- mean(N_vals, na.rm = TRUE)
  tumor_params[i, "N_lower"]     <- N_ci["lower.2.5%"]
  tumor_params[i, "N_upper"]     <- N_ci["upper.97.5%"]
  
  tumor_params[i, "phi_mean"]    <- mean(phi_vals, na.rm = TRUE)
  tumor_params[i, "phi_lower"]   <- phi_ci["lower.2.5%"]
  tumor_params[i, "phi_upper"]   <- phi_ci["upper.97.5%"]
}

tumor_params

write.csv(tumor_params, "tumor_params_GMM_summary.csv", row.names = FALSE)

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(ggplot2)
library(rstan)
library(bayesplot)

# Loop over each tumor
for (i in 1:nrow(tumor_params)) {
  tumor_id   <- tumor_params$Tumor[i]
  psi_1_mean <- tumor_params$psi_1_mean[i]
  psi_2_mean <- tumor_params$psi_2_mean[i]
  psi_3_mean <- tumor_params$psi_3_mean[i]
  X_mean     <- tumor_params$X_mean[i]
  N_mean     <- tumor_params$N_mean[i]
  phi_mean   <- tumor_params$phi_mean[i]
  
  # Retrieve the Stan fit object
  fit <- results_list[[tumor_id]]
  
  
  if (is.na(psi_1_mean)) {
    cat("No valid numeric data for tumor:", tumor_id, "\n\n")
    next
  }
  
  # Prepare data
  y_to_plot <- tumor_data[[tumor_id]]
  y_to_plot <- y_to_plot[is.finite(y_to_plot)]
  if (length(y_to_plot) == 0) {
    cat("No valid numeric data for tumor:", tumor_id, "\n\n")
    next
  }
  
  # Means for each Gaussian
  mu_left    <- X_mean
  mu_middle  <- 0.5
  mu_right   <- 1 - X_mean
  
  # Variances
  var_left   <- X_mean * (1 - X_mean) / N_mean
  var_middle <- 0.25 / N_mean
  var_right  <- X_mean * (1 - X_mean) / N_mean
  
  sigma_left   <- sqrt(var_left)
  sigma_middle <- sqrt(var_middle)
  sigma_right  <- sqrt(var_right)
  
  # Plot of [0,1]
  xgrid <- seq(0, 1, length.out = 200)
  
  left_density   <- dnorm(xgrid, mean = mu_left, sd = sigma_left)
  middle_density <- dnorm(xgrid, mean = mu_middle, sd = sigma_middle)
  right_density  <- dnorm(xgrid, mean = mu_right, sd = sigma_right)
  
  mixture_density <- psi_1_mean * left_density +
                     psi_2_mean * middle_density +
                     psi_3_mean * right_density
  
  plot_data <- data.frame(
    x       = xgrid,
    mixture = mixture_density,
    left    = psi_1_mean * left_density,
    middle  = psi_2_mean * middle_density,
    right   = psi_3_mean * right_density
  )
  
  # Create the summary plot
  p <- ggplot() +
    geom_histogram(
      aes(x = y_to_plot, y = ..density..),
      bins = 50, fill = "lightgray", color = "white"
    ) +
    geom_line(data = plot_data, aes(x = x, y = mixture),
              color = "blue", size = 1) +
    geom_line(data = plot_data, aes(x = x, y = left),
              color = "red", linetype = "dashed", size = 1) +
    geom_line(data = plot_data, aes(x = x, y = middle),
              color = "green", linetype = "dashed", size = 1) +
    geom_line(data = plot_data, aes(x = x, y = right),
              color = "purple", linetype = "dashed", size = 1) +
    labs(
      title = paste("Tumor:", tumor_id, "- Posterior Mixture Plot"),
      x = "Methylation Value", y = "Density"
    ) +
    theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5))
  
  print(p)
  
  # Print numeric summary below the plot
  cat("### Tumor:", tumor_id, "- Posterior Summary (Stan Fit)\n")
  print(fit, pars = c("psi[1]", "psi[2]", "psi[3]", "X", "N", "phi"))
  cat("\n\n")
  
  tr <- traceplot(fit, pars = c("psi[1]", "psi[2]", "psi[3]", "X", "N"),
                  inc_warmup = FALSE, nrow = 2)
  # Add a ggtitle
  tr <- tr + ggtitle(paste("Traceplot for tumor:", tumor_id))
  print(tr)
  
  pairs(
    fit,
    pars = c("psi[1]", "psi[2]", "psi[3]", "X", "N"),
    las = 1,
    color_by_chain = FALSE,
    main = paste("Pairs Plot for tumor:", tumor_id),
  )
  
  acf_plot <- mcmc_acf(as.array(fit), pars = c("psi[1]", "psi[2]", "psi[3]", "X", "N")) +
    ggtitle(paste("Autocorrelation Plot for Tumor:", tumor_id))
  
  print(acf_plot)
  
  cat("\n\n")
}


```