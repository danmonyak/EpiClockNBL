---
title: "Gaussian mixture model for tumor age inference"
author: "Graham Gumbert"
date: "`r Sys.Date()`"
output:
  # pdf_document: default
  html_document: default
params:
  # dataset: "Henrich"
  # beta_vals_filename: "Henrich.methyl.TARGET_Clock_sites.tsv"
  dataset: "TARGET"
  beta_vals_filename: "NBL.methyl.antiNonIterClustNotStuck_sites.tsv"
  # beta_vals_file_suffix: "methyl.TARGET_Clock_sites.tsv"
  cloud_path: "~/Library/CloudStorage/Box-Box/PROJECT 06023: MolClocks/Neuroblastoma_Paper/Datasets"
  output_file_suffix: "GMM_results.csv"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(rstan)
library(dplyr)
library(ggplot2)
library(bayesplot)
library(reshape2)

rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
```

## Read in data

```{r import-data}
# beta_vals_filename <- paste(params$dataset, params$beta_vals_file_suffix, sep='.')
data <- read.table(file.path(params$cloud_path, params$dataset,
                             params$beta_vals_filename), 
                   header = TRUE, sep = "\t")

site_ids <- data[[1]]
tumor_data <- data[,-1]

num_tumors <- ncol(tumor_data)
num_sites <- nrow(tumor_data)

cat("Number of sites:", num_sites, "\n")
cat("Number of tumors:", num_tumors, "\n")
```

## Compile Stan model

```{r compile-model}
sm <- stan_model("gmm.stan")
```

## Fit Stan model on beta-val distributions and save results in results_list

```{r fit-models, cache=F, echo = T, results = 'hide'}
# We'll loop through each column and fit the model
all.results <- NULL # Collect the summary results in a dataframe
                    #     after each tumor is fit

for (j in 1:ncol(tumor_data)) {
  tumor_id <- colnames(tumor_data)[j]
  
  y <- tumor_data[[tumor_id]]
  y <- y[!is.na(y)]
  y <- y[is.finite(y)]
  N_obs <- length(y)

  if (N_obs == 0) {
    cat("No valid numeric data for tumor:", tumor_id, "\n")
    next
  }

  # Fit the model
  fit <- sampling(
    object  = sm,
    data    = list(N_data = N_obs, y = y),
    chains  = 4,
    iter    = 4000,
    warmup  = 2000,
    seed    = 42,
    control = list(adapt_delta = 0.99, max_treedepth = 15)
  )

  if (is.null(fit)) {
    print('########################################')
    print('########################################')
    print(sprintf('######## %s failed ###############', tumor_id))
    print('########################################')
    print('########################################')
    next
  }
  
  # Extracting summary results
  summary.stats <- as.data.frame(summary(fit)$summary)
  
  summary.stats$param <- rownames(summary.stats)
  summary.stats.longForm <- melt(summary.stats, id='param')
  rownames(summary.stats.longForm) <- paste(summary.stats.longForm$param, summary.stats.longForm$variable, sep='.')
  summary.stats.longForm <- summary.stats.longForm['value']
  names(summary.stats.longForm) <- tumor_id
  
  all.results <- rbind(all.results, t(summary.stats.longForm))

  #############################################
  #############################################
  ############## Create figures ###############
  #############################################
  #############################################
  
  psi_1_mean <- summary.stats['psi[1]', 'mean']
  psi_2_mean <- summary.stats['psi[2]', 'mean']
  psi_3_mean <- summary.stats['psi[3]', 'mean']
  X_mean     <- summary.stats['X', 'mean']
  N_mean     <- summary.stats['N', 'mean']
  phi_mean   <- summary.stats['phi', 'mean']
  
  
  if (is.na(psi_1_mean)) {
    cat("No valid numeric data for tumor:", tumor_id, "\n\n")
    next
  }
  
  # Prepare data
  y_to_plot <- tumor_data[[tumor_id]]
  y_to_plot <- y_to_plot[is.finite(y_to_plot)]
  if (length(y_to_plot) == 0) {
    cat("No valid numeric data for tumor:", tumor_id, "\n\n")
    next
  }
  
  # Means for each Gaussian
  mu_left    <- X_mean
  mu_middle  <- 0.5
  mu_right   <- 1 - X_mean
  
  # Variances
  var_left   <- X_mean * (1 - X_mean) / N_mean
  var_middle <- 0.25 / N_mean
  var_right  <- X_mean * (1 - X_mean) / N_mean
  
  sigma_left   <- sqrt(var_left)
  sigma_middle <- sqrt(var_middle)
  sigma_right  <- sqrt(var_right)
  
  # Plot of [0,1]
  xgrid <- seq(0, 1, length.out = 200)
  
  left_density   <- dnorm(xgrid, mean = mu_left, sd = sigma_left)
  middle_density <- dnorm(xgrid, mean = mu_middle, sd = sigma_middle)
  right_density  <- dnorm(xgrid, mean = mu_right, sd = sigma_right)
  
  mixture_density <- psi_1_mean * left_density +
                     psi_2_mean * middle_density +
                     psi_3_mean * right_density
  
  plot_data <- data.frame(
    x       = xgrid,
    mixture = mixture_density,
    left    = psi_1_mean * left_density,
    middle  = psi_2_mean * middle_density,
    right   = psi_3_mean * right_density
  )
  
  # Create the summary plot
  p <- ggplot() +
    geom_histogram(
      aes(x = y_to_plot, y = ..density..),
      bins = 50, fill = "lightgray", color = "white"
    ) +
    geom_line(data = plot_data, aes(x = x, y = mixture),
              color = "blue", size = 1) +
    geom_line(data = plot_data, aes(x = x, y = left),
              color = "red", linetype = "dashed", size = 1) +
    geom_line(data = plot_data, aes(x = x, y = middle),
              color = "green", linetype = "dashed", size = 1) +
    geom_line(data = plot_data, aes(x = x, y = right),
              color = "purple", linetype = "dashed", size = 1) +
    labs(
      title = paste("Tumor:", tumor_id, "- Posterior Mixture Plot"),
      x = "Methylation Value", y = "Density"
    ) +
    theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5))
  
  print(p)
  
  # Print numeric summary below the plot
  cat("### Tumor:", tumor_id, "- Posterior Summary (Stan Fit)\n")
  print(fit, pars = c("psi[1]", "psi[2]", "psi[3]", "X", "N", "phi"))
  cat("\n\n")
  
  tr <- traceplot(fit, pars = c("psi[1]", "psi[2]", "psi[3]", "X", "N"),
                  inc_warmup = FALSE, nrow = 2)
  # Add a ggtitle
  tr <- tr + ggtitle(paste("Traceplot for tumor:", tumor_id))
  print(tr)
  
  pairs(
    fit,
    pars = c("psi[1]", "psi[2]", "psi[3]", "X", "N"),
    las = 1,
    color_by_chain = FALSE,
    main = paste("Pairs Plot for tumor:", tumor_id),
  )
  
  acf_plot <- mcmc_acf(as.array(fit), pars = c("psi[1]", "psi[2]", "psi[3]", "X", "N")) +
    ggtitle(paste("Autocorrelation Plot for Tumor:", tumor_id))
  
  print(acf_plot)
  
  cat("\n\n")
}

output_filename <- paste(params$dataset, params$output_file_suffix, sep='.')
write.csv(all.results, output_filename, row.names = T)
```
