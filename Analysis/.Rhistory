find.package("TCGABiolinks")
find.package("TCGAiolinks")
find.package("TCGAbiolinks")
remove.packages('TCGAbiolinks')
getwd()
setwd('/Users/danielmonyak/Documents/Duke/lab/TCGAbiolinks')
getwd()
library(devtools)
devtools::load_all(".")   # for interactive testing
devtools::load_all(".")   # for interactive testing
devtools::install(".")    # to install your modified version
knitr::opts_chunk$set(echo = TRUE)
# This package streamlines the data pull from GDC
library(TCGAbiolinks)
library(BiocFileCache) # Need to load this directly to set off hook in .Rprofile
# deals with issue when calling GDCprepare
library(plyr)
keepN_fields <- function(x, n) {
fields <- strsplit(x, "-")[[1]]
paste(fields[1:n], collapse = "-")
}
getParticipantIDs <- function(fullTumorIDs) {
sapply(fullTumorIDs, function (x) keepN_fields(x, 3), USE.NAMES=F)
}
getTumorIDs <- function(fullTumorIDs) {
sapply(fullTumorIDs, function (x) keepN_fields(x, 4), USE.NAMES=F)
}
query_clinical <- GDCquery_clinic(project = params$project, type = "clinical")
participant_subset <- query_clinical$submitter_id
length(participant_subset)
methyl.platform <- "Illumina Human Methylation 450"
query_methyl <- GDCquery(project = params$project,
data.category = 'DNA Methylation',
platform = c(methyl.platform),
data.type = "Methylation Beta Value",
sample.type = c("Primary Tumor"),
barcode = participant_subset)
methyl_participant_ids <- getParticipantIDs(getResults(query_methyl, cols = "cases"))
methyl_tumor_ids <- getTumorIDs(getResults(query_methyl, cols = "cases"))
# We limit our dataset to include only participants with methylation data
has_methyl <- query_clinical$submitter_id %in% methyl_participant_ids
query_clinical$reason_methyl <- !has_methyl
reasons <- c("reason_methyl")
length(methyl_participant_ids)
length(participant_subset)
# methyl_tumor_ids <- methyl_tumor_ids[1:10]
# methyl_tumor_ids <- c("TARGET-30-PAIFXV-01A", "TARGET-30-PAISNS-01A",
#                       "TARGET-30-PAITCI-01A", "TARGET-30-PAIVHE-01A",
#                       "TARGET-30-PAIVMJ-01A", "TARGET-30-PAIVZR-01A",
#                       "TARGET-30-PAIXFZ-01A", "TARGET-30-PAKHAV-01A")
common_tumors <- sort(methyl_tumor_ids)
duplicated.participants <- duplicated(getParticipantIDs(common_tumors)) |
duplicated(getParticipantIDs(common_tumors), fromLast = TRUE)
duplicated.tumors <- duplicated(common_tumors) | duplicated(common_tumors, fromLast = TRUE)
dups <- duplicated.participants & !duplicated.tumors
dups
sum(dups)
length(participant_subset)
length(unique(methyl_participant_ids))
sum(duplicated(methyl_participant_ids))
sum(duplicated(methyl_tumor_ids))
# methyl_tumor_ids <- methyl_tumor_ids[1:10]
# methyl_tumor_ids <- c("TARGET-30-PAIFXV-01A", "TARGET-30-PAISNS-01A",
#                       "TARGET-30-PAITCI-01A", "TARGET-30-PAIVHE-01A",
#                       "TARGET-30-PAIVMJ-01A", "TARGET-30-PAIVZR-01A",
#                       "TARGET-30-PAIXFZ-01A", "TARGET-30-PAKHAV-01A")
common_tumors <- sort(methyl_tumor_ids)
duplicated.participants <- duplicated(getParticipantIDs(common_tumors)) |
duplicated(getParticipantIDs(common_tumors), fromLast = TRUE)
duplicated.tumors <- duplicated(common_tumors) | duplicated(common_tumors, fromLast = TRUE)
dups <- duplicated.participants & !duplicated.tumors
unique(getParticipantIDs(common_tumors)[dups]
)
methyl_tumor_ids[duplicated(methyl_tumor_ids)]
participant_subset
methyl_tumor_ids
'TARGET-30-PATYIL-01A' %in% methyl_tumor_ids
'TARGET-30-PATYIL-02A' %in% methyl_tumor_ids
length(methyl_tumor_ids)
length(participant_subset)
knitr::opts_chunk$set(echo = TRUE)
# This package streamlines the data pull from GDC
library(TCGAbiolinks)
library(BiocFileCache) # Need to load this directly to set off hook in .Rprofile
# deals with issue when calling GDCprepare
library(plyr)
keepN_fields <- function(x, n) {
fields <- strsplit(x, "-")[[1]]
paste(fields[1:n], collapse = "-")
}
getParticipantIDs <- function(fullTumorIDs) {
sapply(fullTumorIDs, function (x) keepN_fields(x, 3), USE.NAMES=F)
}
getTumorIDs <- function(fullTumorIDs) {
sapply(fullTumorIDs, function (x) keepN_fields(x, 4), USE.NAMES=F)
}
knitr::opts_chunk$set(echo = TRUE)
# This package streamlines the data pull from GDC
library(TCGAbiolinks)
library(BiocFileCache) # Need to load this directly to set off hook in .Rprofile
# deals with issue when calling GDCprepare
library(plyr)
keepN_fields <- function(x, n) {
fields <- strsplit(x, "-")[[1]]
paste(fields[1:n], collapse = "-")
}
getParticipantIDs <- function(fullTumorIDs) {
sapply(fullTumorIDs, function (x) keepN_fields(x, 3), USE.NAMES=F)
}
getTumorIDs <- function(fullTumorIDs) {
sapply(fullTumorIDs, function (x) keepN_fields(x, 4), USE.NAMES=F)
}
query_clinical <- GDCquery_clinic(project = params$project, type = "clinical")
participant_subset <- query_clinical$submitter_id
methyl.platform <- "Illumina Human Methylation 450"
query_methyl <- GDCquery(project = params$project,
data.category = 'DNA Methylation',
platform = c(methyl.platform),
data.type = "Methylation Beta Value",
sample.type = c("Primary Tumor"),
barcode = participant_subset)
methyl_participant_ids <- getParticipantIDs(getResults(query_methyl, cols = "cases"))
methyl_tumor_ids <- getTumorIDs(getResults(query_methyl, cols = "cases"))
# We limit our dataset to include only participants with methylation data
has_methyl <- query_clinical$submitter_id %in% methyl_participant_ids
query_clinical$reason_methyl <- !has_methyl
reasons <- c("reason_methyl")
# methyl_tumor_ids <- methyl_tumor_ids[1:10]
# methyl_tumor_ids <- c("TARGET-30-PAIFXV-01A", "TARGET-30-PAISNS-01A",
#                       "TARGET-30-PAITCI-01A", "TARGET-30-PAIVHE-01A",
#                       "TARGET-30-PAIVMJ-01A", "TARGET-30-PAIVZR-01A",
#                       "TARGET-30-PAIXFZ-01A", "TARGET-30-PAKHAV-01A")
common_tumors <- sort(methyl_tumor_ids)
duplicated.participants <- duplicated(getParticipantIDs(common_tumors)) |
duplicated(getParticipantIDs(common_tumors), fromLast = TRUE)
duplicated.tumors <- duplicated(common_tumors) | duplicated(common_tumors, fromLast = TRUE)
dups <- duplicated.participants & !duplicated.tumors
dups
sum(dups)
has_multiple_tumors <- query_clinical$submitter_id %in% {getParticipantIDs(common_tumors)[dups]}
query_clinical$note_multiple_tumors <- has_multiple_tumors
print(common_tumors[dups])
# add column to clinical data indicating if participant is kept in our dataset
query_clinical$in_CpG_dataset <- query_clinical$submitter_id %in% getParticipantIDs(common_tumors)
# ensure that something did not go wrong
# code_given <- apply(query_clinical[, reasons], 1L, any)
code_given <- query_clinical[, 'reason_methyl']
################################################
#################### delete ####################
# There are some tumors that have methylation data but fail purity test or
# pass purity test, but have no methylation data
# query_clinical$reason_methyl_and_purity <- !query_clinical$in_CpG_dataset & !code_given
# reasons <- c(reasons, "reason_methyl_and_purity")
# code_given <- apply(query_clinical[, reasons], 1L, any)
# cat("The tumors with methylation data are\n")
# print(methyl_tumor_ids[methyl_participant_ids %in% query_clinical$submitter_id[query_clinical$reason_methyl_and_purity]])
################################################
################################################
# colSums(query_clinical[, reasons])
sum(query_clinical[, 'reason_methyl'])
# The analysis dataset
query_clinical$in_analysis_dataset <- query_clinical$in_CpG_dataset
# colSums(query_clinical[, c(reasons, "note_multiple_tumors")])
colSums(query_clinical[, c('reason_methyl', "note_multiple_tumors")])
query_methyl <- GDCquery(project = params$project,
data.category = 'DNA Methylation',
platform = c(methyl.platform),
sample.type = c("Primary Tumor"),
data.type = "Methylation Beta Value",
barcode = unique(getParticipantIDs(common_tumors)))
# download and save the DNA methylation data
GDCdownload(query_methyl, directory = paste0(params$save_path, params$GDCdata_dir))
query_methyl
common_tumors
length(common_tumors)
getParticipantIDs(common_tumors))
getParticipantIDs(common_tumors)
x = getParticipantIDs(common_tumors)
x[duplicated(x)]
# download and save the DNA methylation data
GDCdownload(query_methyl, directory = paste0(params$save_path, params$GDCdata_dir))
data.methyl <- GDCprepare(query_methyl,
directory = paste0(params$save_path, params$GDCdata_dir))
install.packages('sesameData')
BiocManager::install("sesameData")
library('sesameData')
getwd()
setwd('../TCGA Retrieval')
getwd()
knitr::opts_chunk$set(echo = TRUE)
# This package streamlines the data pull from GDC
library(TCGAbiolinks)
library(BiocFileCache) # Need to load this directly to set off hook in .Rprofile
# deals with issue when calling GDCprepare
library(plyr)
keepN_fields <- function(x, n) {
fields <- strsplit(x, "-")[[1]]
paste(fields[1:n], collapse = "-")
}
getParticipantIDs <- function(fullTumorIDs) {
sapply(fullTumorIDs, function (x) keepN_fields(x, 3), USE.NAMES=F)
}
getTumorIDs <- function(fullTumorIDs) {
sapply(fullTumorIDs, function (x) keepN_fields(x, 4), USE.NAMES=F)
}
query_clinical <- GDCquery_clinic(project = params$project, type = "clinical")
participant_subset <- query_clinical$submitter_id
participant_subset <- participant_subset[1:10]
methyl.platform <- "Illumina Human Methylation 450"
query_methyl <- GDCquery(project = params$project,
data.category = 'DNA Methylation',
platform = c(methyl.platform),
data.type = "Methylation Beta Value",
sample.type = c("Primary Tumor"),
barcode = participant_subset)
methyl_participant_ids <- getParticipantIDs(getResults(query_methyl, cols = "cases"))
methyl_tumor_ids <- getTumorIDs(getResults(query_methyl, cols = "cases"))
# We limit our dataset to include only participants with methylation data
has_methyl <- query_clinical$submitter_id %in% methyl_participant_ids
query_clinical$reason_methyl <- !has_methyl
reasons <- c("reason_methyl")
# methyl_tumor_ids <- methyl_tumor_ids[1:10]
# methyl_tumor_ids <- c("TARGET-30-PAIFXV-01A", "TARGET-30-PAISNS-01A",
#                       "TARGET-30-PAITCI-01A", "TARGET-30-PAIVHE-01A",
#                       "TARGET-30-PAIVMJ-01A", "TARGET-30-PAIVZR-01A",
#                       "TARGET-30-PAIXFZ-01A", "TARGET-30-PAKHAV-01A")
common_tumors <- sort(methyl_tumor_ids)
duplicated.participants <- duplicated(getParticipantIDs(common_tumors)) |
duplicated(getParticipantIDs(common_tumors), fromLast = TRUE)
duplicated.tumors <- duplicated(common_tumors) | duplicated(common_tumors, fromLast = TRUE)
dups <- duplicated.participants & !duplicated.tumors
has_multiple_tumors <- query_clinical$submitter_id %in% {getParticipantIDs(common_tumors)[dups]}
query_clinical$note_multiple_tumors <- has_multiple_tumors
print(common_tumors[dups])
# add column to clinical data indicating if participant is kept in our dataset
query_clinical$in_CpG_dataset <- query_clinical$submitter_id %in% getParticipantIDs(common_tumors)
# ensure that something did not go wrong
# code_given <- apply(query_clinical[, reasons], 1L, any)
code_given <- query_clinical[, 'reason_methyl']
################################################
#################### delete ####################
# There are some tumors that have methylation data but fail purity test or
# pass purity test, but have no methylation data
# query_clinical$reason_methyl_and_purity <- !query_clinical$in_CpG_dataset & !code_given
# reasons <- c(reasons, "reason_methyl_and_purity")
# code_given <- apply(query_clinical[, reasons], 1L, any)
# cat("The tumors with methylation data are\n")
# print(methyl_tumor_ids[methyl_participant_ids %in% query_clinical$submitter_id[query_clinical$reason_methyl_and_purity]])
################################################
################################################
# colSums(query_clinical[, reasons])
sum(query_clinical[, 'reason_methyl'])
# The analysis dataset
query_clinical$in_analysis_dataset <- query_clinical$in_CpG_dataset
# colSums(query_clinical[, c(reasons, "note_multiple_tumors")])
colSums(query_clinical[, c('reason_methyl', "note_multiple_tumors")])
query_methyl <- GDCquery(project = params$project,
data.category = 'DNA Methylation',
platform = c(methyl.platform),
sample.type = c("Primary Tumor"),
data.type = "Methylation Beta Value",
barcode = unique(getParticipantIDs(common_tumors)))
query_gene <- GDCquery(project = params$project,
data.category = 'Transcriptome Profiling',
data.type = 'Gene Expression Quantification',
workflow.type = 'STAR - Counts',
experimental.strategy = "RNA-Seq",
sample.type = c("Primary Tumor"),
barcode = query_clinical$submitter_id[query_clinical$in_analysis_dataset])
query_clinical$submitter_id[query_clinical$in_analysis_dataset]
# download and save the gene expression data
GDCdownload(query_gene, directory = paste0(params$save_path, params$GDCdata_dir))
knitr::opts_chunk$set(echo = TRUE)
# This package streamlines the data pull from GDC
library(TCGAbiolinks)
library(BiocFileCache) # Need to load this directly to set off hook in .Rprofile
# deals with issue when calling GDCprepare
library(plyr)
keepN_fields <- function(x, n) {
fields <- strsplit(x, "-")[[1]]
paste(fields[1:n], collapse = "-")
}
getParticipantIDs <- function(fullTumorIDs) {
sapply(fullTumorIDs, function (x) keepN_fields(x, 3), USE.NAMES=F)
}
getTumorIDs <- function(fullTumorIDs) {
sapply(fullTumorIDs, function (x) keepN_fields(x, 4), USE.NAMES=F)
}
query_clinical <- GDCquery_clinic(project = params$project, type = "clinical")
participant_subset <- query_clinical$submitter_id
methyl.platform <- "Illumina Human Methylation 450"
query_methyl <- GDCquery(project = params$project,
data.category = 'DNA Methylation',
platform = c(methyl.platform),
data.type = "Methylation Beta Value",
sample.type = c("Primary Tumor"),
barcode = participant_subset)
methyl_participant_ids <- getParticipantIDs(getResults(query_methyl, cols = "cases"))
methyl_tumor_ids <- getTumorIDs(getResults(query_methyl, cols = "cases"))
# We limit our dataset to include only participants with methylation data
has_methyl <- query_clinical$submitter_id %in% methyl_participant_ids
query_clinical$reason_methyl <- !has_methyl
reasons <- c("reason_methyl")
# methyl_tumor_ids <- methyl_tumor_ids[1:10]
# methyl_tumor_ids <- c("TARGET-30-PAIFXV-01A", "TARGET-30-PAISNS-01A",
#                       "TARGET-30-PAITCI-01A", "TARGET-30-PAIVHE-01A",
#                       "TARGET-30-PAIVMJ-01A", "TARGET-30-PAIVZR-01A",
#                       "TARGET-30-PAIXFZ-01A", "TARGET-30-PAKHAV-01A")
common_tumors <- sort(methyl_tumor_ids)
duplicated.participants <- duplicated(getParticipantIDs(common_tumors)) |
duplicated(getParticipantIDs(common_tumors), fromLast = TRUE)
duplicated.tumors <- duplicated(common_tumors) | duplicated(common_tumors, fromLast = TRUE)
dups <- duplicated.participants & !duplicated.tumors
# DELETE
common_tumors <- common_tumors[1:10]
has_multiple_tumors <- query_clinical$submitter_id %in% {getParticipantIDs(common_tumors)[dups]}
query_clinical$note_multiple_tumors <- has_multiple_tumors
print(common_tumors[dups])
# add column to clinical data indicating if participant is kept in our dataset
query_clinical$in_CpG_dataset <- query_clinical$submitter_id %in% getParticipantIDs(common_tumors)
# ensure that something did not go wrong
# code_given <- apply(query_clinical[, reasons], 1L, any)
code_given <- query_clinical[, 'reason_methyl']
################################################
#################### delete ####################
# There are some tumors that have methylation data but fail purity test or
# pass purity test, but have no methylation data
# query_clinical$reason_methyl_and_purity <- !query_clinical$in_CpG_dataset & !code_given
# reasons <- c(reasons, "reason_methyl_and_purity")
# code_given <- apply(query_clinical[, reasons], 1L, any)
# cat("The tumors with methylation data are\n")
# print(methyl_tumor_ids[methyl_participant_ids %in% query_clinical$submitter_id[query_clinical$reason_methyl_and_purity]])
################################################
################################################
# colSums(query_clinical[, reasons])
sum(query_clinical[, 'reason_methyl'])
# The analysis dataset
query_clinical$in_analysis_dataset <- query_clinical$in_CpG_dataset
# colSums(query_clinical[, c(reasons, "note_multiple_tumors")])
colSums(query_clinical[, c('reason_methyl', "note_multiple_tumors")])
query_methyl <- GDCquery(project = params$project,
data.category = 'DNA Methylation',
platform = c(methyl.platform),
sample.type = c("Primary Tumor"),
data.type = "Methylation Beta Value",
barcode = unique(getParticipantIDs(common_tumors)))
query_gene <- GDCquery(project = params$project,
data.category = 'Transcriptome Profiling',
data.type = 'Gene Expression Quantification',
workflow.type = 'STAR - Counts',
experimental.strategy = "RNA-Seq",
sample.type = c("Primary Tumor"),
barcode = query_clinical$submitter_id[query_clinical$in_analysis_dataset])
gene_participant_ids <- getParticipantIDs(getResults(query_gene, cols = "cases"))
gene_tumor_ids <- getTumorIDs(getResults(query_gene, cols = "cases"))
# download and save the gene expression data
GDCdownload(query_gene, directory = paste0(params$save_path, params$GDCdata_dir))
data.seq <- GDCprepare(query_gene,
directory = paste0(params$save_path, params$GDCdata_dir))
# download and save the DNA methylation data
GDCdownload(query_methyl, directory = paste0(params$save_path, params$GDCdata_dir))
data.methyl <- GDCprepare(query_methyl,
directory = paste0(params$save_path, params$GDCdata_dir))
BiocManager::install("sesame")
# download and save the DNA methylation data
GDCdownload(query_methyl, directory = paste0(params$save_path, params$GDCdata_dir))
data.methyl <- GDCprepare(query_methyl,
directory = paste0(params$save_path, params$GDCdata_dir))
methyl <- data.methyl@assays@data[[1L]]
colnames(methyl) <- rownames(data.methyl@colData)
# subset to the specific tumors in the CpG dataset
methyl <- methyl[, getTumorIDs(colnames(methyl)) %in% common_tumors]
# some tumors have multiple methylation measurements, remove 1
dups <- duplicated(getTumorIDs(colnames(methyl)))
cat("Tumors with multiple measurements:")
print(getTumorIDs(colnames(methyl))[dups])
tumors.dups.methyl <- colnames(methyl)[dups | duplicated(getTumorIDs(colnames(methyl)), fromLast = TRUE)]
print(tumors.dups.methyl)
has_multiple_methyl <- query_clinical$submitter_id %in% getParticipantIDs(colnames(methyl))[dups]
query_clinical$note_multiple_methyl <- has_multiple_methyl
dups.remove <- tumors.dups.methyl[sapply(tumors.dups.methyl, function (x) substr(x, nchar(x)-2, nchar(x))) == '02D']
methyl <- methyl[, !(colnames(methyl) %in% c(dups.remove))]
write.table(methyl,
file = paste0(params$save_path, params$methyl_filename, ".tsv"),
sep = "\t")
if (params$save_data_as_rds) saveRDS(methyl,
file = paste0(params$save_path,
params$methyl_filename,
".rds"))
dim(methyl)
rm(methyl, data.methyl, query_methyl)
query_clinical_general <- GDCquery(
project = params$project,
data.category = "Clinical",
data.type = "Clinical Supplement",
data.format = "BCR XML",
# barcode = query_clinical$submitter_id[query_clinical$in_analysis_dataset]
)
# Download the IHC
GDCdownload(query_clinical_general, directory = paste0(params$save_path, params$GDCdata_dir))
# Import follow up data
clinical_mycnAmp <- GDCprepare_clinic(query_clinical_general, clinical.info = "patient",
directory = paste0(params$save_path, params$GDCdata_dir))
knitr::opts_chunk$set(echo = TRUE)
library(survival)
library(ggplot2)
library(dplyr)
library(ggfortify)
library(survminer)
library(kableExtra)
official_indir <- '/Users/danielmonyak/Library/CloudStorage/Box-Box/PROJECT 06023: MolClocks/Neuroblastoma_Paper/Datasets'
proj_dir <- file.path(official_indir, 'TARGET')
clinical <- read.table(file.path(proj_dir, 'clinical.annotated.survival.tsv'), sep='\t', header=T)
sf = 0.6
label_fontsize <- 16
p_val_size <- 4
# Restrict columns
survival_data <- data.frame(
Patient=clinical$submitter_id,
event=as.numeric(clinical$vital_status == 'Dead'),
time=clinical$days_to_follow_up / 365,
mitotic.age=clinical$phi,                # Use phi as tumor mitotic age
inss_stage=clinical$inss_stage,
cog_neuroblastoma_risk_group=clinical$cog_neuroblastoma_risk_group,
mitosis_karyorrhexis_index=clinical$mitosis_karyorrhexis_index,
inpc_grade=clinical$inpc_grade,
gender=clinical$gender
)
any(is.na(survival_data))
sprintf('%d samples available', nrow(survival_data))
# KM curves
#########################################################
############### stratify by mitotic.age #################
#########################################################
# Halves
survival_data <- survival_data %>%
mutate(dichom = ntile(mitotic.age, 2),
dichom = factor(dichom, levels = c(1, 2), labels = c("Young", "Old")))
#######################################
########### All tumors ################
#######################################
fit <- survfit(Surv(time, event) ~ dichom, data=survival_data)
# Compute p-value
logrank <- survdiff(Surv(time, event) ~ dichom, data = survival_data)
p_val <- 1 - pchisq(logrank$chisq, df = length(logrank$n) - 1)
p_label <- paste0("P = ", signif(p_val, 2))
# Plot with customizations and p-value
km_plot <- autoplot(fit) +
ylim(0, 1) +
labs(
x = "Time since diagnosis (years)",
y = "Survival",
title = sprintf('All tumors (N = %d)', sum(logrank$n))
) +
annotate("text", x = 12, y = 0.9, label = p_label, size = sf * p_val_size) +
theme_classic() +
theme(plot.title = element_text(size=sf * label_fontsize, hjust = 0.5),
axis.title = element_text(size=sf * label_fontsize),
legend.title = element_blank(),
legend.text = element_text(size=sf * label_fontsize * 0.8),
legend.position = c(0.03, 0.05),  # bottom-left corner
legend.justification = c(0, 0)
) +
scale_color_discrete(labels = c(
sprintf('Young tumors (n = %d)', logrank$n[['dichom=Young']]),
sprintf('Old tumors (n = %d)', logrank$n[['dichom=Old']])
)) +
scale_fill_discrete(labels = c(
sprintf('Young tumors (n = %d)', logrank$n[['dichom=Young']]),
sprintf('Old tumors (n = %d)', logrank$n[['dichom=Old']])
))
ggsave(file.path('figures', "km_plot.svg"), km_plot, width = sf * 6, height = sf * 5, dpi = 800, device='svg')
km_plot
####################################
########### Stage 4 ################
####################################
# Halves
# survival_data <- survival_data[survival_data$inss_stage == 'Stage 4',] %>%
#     mutate(dichom = ntile(mitotic.age, 2),
#     dichom = factor(dichom, levels = c(1, 2), labels = c("Young", "Old")))
fit<-survfit(Surv(time, event) ~ dichom, data=survival_data, subset = inss_stage == "Stage 4")
# Compute p-value
logrank <- survdiff(Surv(time, event) ~ dichom, data=survival_data, subset = inss_stage == "Stage 4")
p_val <- 1 - pchisq(logrank$chisq, df = length(logrank$n) - 1)
p_label <- paste0("P = ", signif(p_val, 2))
# Plot with customizations and p-value
km_plot_4 <- autoplot(fit) +
ylim(0, 1) +
labs(
x = "Time since diagnosis (years)",
y = "Survival",
title = sprintf('Stage 4 tumors (N = %d)', sum(logrank$n))
) +
annotate("text", x = 12, y = 0.9, label = p_label, size = sf * p_val_size) +
theme_classic() +
theme(plot.title = element_text(size=sf * label_fontsize, hjust = 0.5),
axis.title = element_text(size=sf * label_fontsize),
legend.title = element_blank(),
legend.text = element_text(size=sf * label_fontsize * 0.8),
legend.position = c(0.03, 0.05),  # bottom-left corner
legend.justification = c(0, 0)
) +
scale_color_discrete(labels = c(
sprintf('Young tumors (n = %d)', logrank$n[['dichom=Young']]),
sprintf('Old tumors (n = %d)', logrank$n[['dichom=Old']])
)) +
scale_fill_discrete(labels = c(
sprintf('Young tumors (n = %d)', logrank$n[['dichom=Young']]),
sprintf('Old tumors (n = %d)', logrank$n[['dichom=Old']])
))
ggsave(file.path('figures', "km_plot_4.svg"), km_plot_4, width = sf * 6, height = sf * 5, dpi = 800, device='svg')
km_plot_4
