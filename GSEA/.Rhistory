substr(colnames(deseq_normal), 1L, 16L))
if (any(is.na(idx))) stop("tumor names do not match; something is wrong")
deseq_normal <- deseq_normal[, idx]
cat("The names in each dataset line up?",
isTRUE(all.equal(substr(colnames(c_beta_measured), 1, 16),
substr(colnames(deseq_normal), 1, 16))), "\n")
library(DESeq2)
data <- readRDS(paste0(params$dir, params$count_data_file))
is(data)
data$gene_id <- sub("\\..*", "", data$gene_id)
colnames(data) <- sub("-01A.*", "-01A", colnames(data))
colnames(data) <- sub("-01B.*", "-01B", colnames(data))
colnames(data) <- sub("-01C.*", "-01C", colnames(data))
c_beta_measured <- read.table(paste0(params$dir, params$c_beta_file), sep = "\t", header = FALSE)
c_beta_measured <- t(c_beta_measured)
c_beta_measured <- as.data.frame(c_beta_measured)
colnames(c_beta_measured) <- c_beta_measured[1, ]
shared_tumors <- intersect(colnames(data), colnames(c_beta_measured))
data <- data[, c(shared_tumors, "gene_id", "gene_name"), drop = FALSE]
c_beta_measured <- c_beta_measured[, shared_tumors, drop = FALSE]
tumor_order <- head(colnames(data), -2)
c_beta_measured <- c_beta_measured[, tumor_order]
c_beta_measured <- c_beta_measured[-1, ]
c_beta_measured <- as.matrix(c_beta_measured)
colnames(c_beta_measured) <- gsub(".", "-", colnames(c_beta_measured), fixed = TRUE)
# design ~ 1 means we aren't grouping based on categories such as batch, normal/tumor, etc.
deseq_data <- data[, !(colnames(data) %in% c("gene_id", "gene_name"))]
rownames(deseq_data) <- data$gene_id
colData <- data.frame(condition = factor(rep("tumor", ncol(deseq_data))))
rownames(colData) <- colnames(deseq_data)
#
dds <- DESeqDataSetFromMatrix(countData = deseq_data,
colData = colData,
design = ~ 1)
# small scale thining for genes with extremely low counts
keep <- rowSums(counts(dds)) >= 10
dds <- dds[keep,]
# Estimate size factor and extract normalized counts
dds <- estimateSizeFactors(dds)
deseq_normal <- counts(dds, normalized = TRUE)
# keep only those tumors that pertain to our analysis
idx <- match(substr(colnames(c_beta_measured), 1L, 16L),
substr(colnames(deseq_normal), 1L, 16L))
if (any(is.na(idx))) stop("tumor names do not match; something is wrong")
deseq_normal <- deseq_normal[, idx]
cat("The names in each dataset line up?",
isTRUE(all.equal(substr(colnames(c_beta_measured), 1, 16),
substr(colnames(deseq_normal), 1, 16))), "\n")
.convertToGCT <- function(x) {
x_df <- as.data.frame(x)
x_df <- cbind("Description" = NA, x_df)
row.names(x_df) <- sub("\\..*", "", row.names(x_df))
x_df <- cbind("Name" = row.names(x_df), x_df)
x_df
}
.createGCT <- function(x, pth, nm) {
print(nm)
cat("#1.2\n", file = paste0(pth, nm, ".gct"), append = FALSE)
cat(paste0(nrow(x), "\t", ncol(x), "\n"), file = paste0(pth, nm, ".gct"), append = TRUE)
x <- .convertToGCT(x)
cat(paste(colnames(x), collapse = "\t"), "\n", file = paste0(pth, nm, ".gct"), append = TRUE)
write.table(x,
file = paste0(pth, nm, ".gct"),
sep = "\t", quote = FALSE, row.names = FALSE,
col.names = FALSE, append = TRUE)
}
.createGCT(deseq_normal, pth = params$out_dir, nm = params$output_gct_file)
.createCLS <- function(x, pth, nm) {
cat("#numeric\n", file = paste0(pth, nm, ".cls"), append = FALSE)
cat(paste0("#", nm, "\n"), file = paste0(pth, nm, ".cls"), append = TRUE)
write.table(t(drop(x[1L, ])),
file = paste0(pth, nm, ".cls"),
sep = "\t", quote = FALSE, row.names = FALSE,
col.names = FALSE, append = TRUE)
}
.createCLS(c_beta_measured, pth = params$out_dir, nm = params$output_cls_file)
library(DESeq2)
data <- readRDS(paste0(params$dir, params$count_data_file))
is(data)
data$gene_id <- sub("\\..*", "", data$gene_id)
colnames(data) <- sub("-01A.*", "-01A", colnames(data))
colnames(data) <- sub("-01B.*", "-01B", colnames(data))
colnames(data) <- sub("-01C.*", "-01C", colnames(data))
c_beta_measured <- read.table(paste0(params$dir, params$c_beta_file), sep = "\t", header = FALSE)
c_beta_measured <- t(c_beta_measured)
c_beta_measured <- as.data.frame(c_beta_measured)
colnames(c_beta_measured) <- c_beta_measured[1, ]
shared_tumors <- intersect(colnames(data), colnames(c_beta_measured))
data <- data[, c(shared_tumors, "gene_id", "gene_name"), drop = FALSE]
c_beta_measured <- c_beta_measured[, shared_tumors, drop = FALSE]
tumor_order <- head(colnames(data), -2)
c_beta_measured <- c_beta_measured[, tumor_order]
c_beta_measured <- c_beta_measured[-1, ]
c_beta_measured <- as.matrix(c_beta_measured)
colnames(c_beta_measured) <- gsub(".", "-", colnames(c_beta_measured), fixed = TRUE)
# design ~ 1 means we aren't grouping based on categories such as batch, normal/tumor, etc.
deseq_data <- data[, !(colnames(data) %in% c("gene_id", "gene_name"))]
rownames(deseq_data) <- data$gene_id
colData <- data.frame(condition = factor(rep("tumor", ncol(deseq_data))))
rownames(colData) <- colnames(deseq_data)
#
dds <- DESeqDataSetFromMatrix(countData = deseq_data,
colData = colData,
design = ~ 1)
# small scale thining for genes with extremely low counts
keep <- rowSums(counts(dds)) >= 10
dds <- dds[keep,]
# Estimate size factor and extract normalized counts
dds <- estimateSizeFactors(dds)
deseq_normal <- counts(dds, normalized = TRUE)
# keep only those tumors that pertain to our analysis
idx <- match(substr(colnames(c_beta_measured), 1L, 16L),
substr(colnames(deseq_normal), 1L, 16L))
if (any(is.na(idx))) stop("tumor names do not match; something is wrong")
deseq_normal <- deseq_normal[, idx]
cat("The names in each dataset line up?",
isTRUE(all.equal(substr(colnames(c_beta_measured), 1, 16),
substr(colnames(deseq_normal), 1, 16))), "\n")
.convertToGCT <- function(x) {
x_df <- as.data.frame(x)
x_df <- cbind("Description" = NA, x_df)
row.names(x_df) <- sub("\\..*", "", row.names(x_df))
x_df <- cbind("Name" = row.names(x_df), x_df)
x_df
}
.createGCT <- function(x, pth, nm) {
print(nm)
cat("#1.2\n", file = paste0(pth, nm, ".gct"), append = FALSE)
cat(paste0(nrow(x), "\t", ncol(x), "\n"), file = paste0(pth, nm, ".gct"), append = TRUE)
x <- .convertToGCT(x)
cat(paste(colnames(x), collapse = "\t"), "\n", file = paste0(pth, nm, ".gct"), append = TRUE)
write.table(x,
file = paste0(pth, nm, ".gct"),
sep = "\t", quote = FALSE, row.names = FALSE,
col.names = FALSE, append = TRUE)
}
.createGCT(deseq_normal, pth = params$out_dir, nm = params$output_gct_file)
.createCLS <- function(x, pth, nm) {
cat("#numeric\n", file = paste0(pth, nm, ".cls"), append = FALSE)
cat(paste0("#", nm, "\n"), file = paste0(pth, nm, ".cls"), append = TRUE)
write.table(t(drop(x[1L, ])),
file = paste0(pth, nm, ".cls"),
sep = "\t", quote = FALSE, row.names = FALSE,
col.names = FALSE, append = TRUE)
}
.createCLS(c_beta_measured, pth = params$out_dir, nm = params$output_cls_file)
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(ggsci)
library(latex2exp)
prettier <- list()
prettier[[1L]] <- c("APICAL_JUNCTION", "Cellular Component", "Apical Junction")
prettier[[2L]] <- c("APICAL_SURFACE", "Cellular Component", "Apical Surface")
prettier[[3L]] <- c("PEROXISOME", "Cellular Component", "Peroxisomes")
prettier[[4L]] <- c("ADIPOGENESIS", "Development", "Adipogenesis")
prettier[[5L]] <- c("ANGIOGENESIS", "Development", "Angiogenesis")
prettier[[6L]] <- c("EPITHELIAL_MESENCHYMAL_TRANSITION", "Development", "Epithelial Mesenchymal Transition")
prettier[[7L]] <- c("MYOGENESIS", "Development", "Myogenesis")
prettier[[8L]] <- c("SPERMATOGENESIS", "Development", "Spermatogenesis")
prettier[[9L]] <- c("PANCREAS_BETA_CELL", "Development", "Pancreas Beta Cell")
prettier[[10L]] <- c("DNA_REPAIR", "DNA Damage", "DNA Repair")
prettier[[11L]] <- c("UV_RESPONSE_DN", "DNA Damage", "UV Response Down")
prettier[[12L]] <- c("UV_RESPONSE_UP", "DNA Damage", "UV Response Up")
prettier[[13L]] <- c("ALLOGRAFT_REJECTION", "Immune", "Allograft Rejection")
prettier[[14L]] <- c("COAGULATION", "Immune", "Coagulation")
prettier[[15L]] <- c("COMPLEMENT", "Immune", "Complement")
prettier[[16L]] <- c("INTERFERON_ALPHA_RESPONSE", "Immune", "Interferon Alpha Response")
prettier[[17L]] <- c("INTERFERON_GAMMA_RESPONSE", "Immune", "Interferon Gamma Response")
prettier[[18L]] <- c("IL6_JAK_STAT3_SIGNALING", "Immune", "IL6 JAK STAT3 signaling")
prettier[[19L]] <- c("INFLAMMATORY_RESPONSE", "Immune", "Inflammatory Response")
prettier[[20L]] <- c("BILE_ACID_METABOLISM", "Metabolic", "Bile Acide Metabolism")
prettier[[21L]] <- c("CHOLESTEROL_HOMEOSTASIS", "Metabolic", "Cholesterol Homeostasis")
prettier[[22L]] <- c("FATTY_ACID_METABOLISM", "Metabolic", "Fatty Acid Metabolism")
prettier[[23L]] <- c("GLYCOLYSIS", "Metabolic", "Glycolysis")
prettier[[24L]] <- c("HEME_METABOLISM", "Metabolic", "Heme Metabolism")
prettier[[25L]] <- c("OXIDATIVE_PHOSPHORYLATION", "Metabolic", "Oxidative Phosphorylation")
prettier[[26L]] <- c("XENOBIOTIC_METABOLISM", "Metabolic", "Xenobiotic Metabolism")
prettier[[27L]] <- c("APOPTOSIS", "Pathway", "Apoptosis")
prettier[[28L]] <- c("HYPOXIA", "Pathway", "Hypoxia")
prettier[[29L]] <- c("PROTEIN_SECRETION", "Pathway", "Protein Secretion")
prettier[[30L]] <- c("UNFOLDED_PROTEIN_RESPONSE", "Pathway", "Unfolded Protein Response")
prettier[[31L]] <- c("REACTIVE_OXYGEN_SPECIES_PATHWAY", "Pathway", "Reactive Oxygen Species Pathway")
prettier[[32L]] <- c("E2F_TARGETS", "Proliferation", "E2F Targets")
prettier[[33L]] <- c("G2M_CHECKPOINT", "Proliferation", "G2/M Checkpoint")
prettier[[34L]] <- c("MYC_TARGETS_V1", "Proliferation", "MYC Targets Variant 1")
prettier[[35L]] <- c("MYC_TARGETS_V2", "Proliferation", "MYC Targets Variant 2")
prettier[[36L]] <- c("P53_PATHWAY", "Proliferation", "p53 Pathway")
prettier[[37L]] <- c("MITOTIC_SPINDLE", "Proliferation", "Mitotic Spindle")
prettier[[38L]] <- c("ANDROGEN_RESPONSE", "Signaling", "Androgen Response")
prettier[[39L]] <- c("ESTROGEN_RESPONSE_EARLY", "Signaling", "Estrogen Response Early")
prettier[[40L]] <- c("ESTROGEN_RESPONSE_LATE", "Signaling", "Estrogen Response Late")
prettier[[41L]] <- c("IL2_STAT5_SIGNALING", "Signaling", "IL2 JAK STAT5 Signaling")
prettier[[42L]] <- c("KRAS_SIGNALING_UP", "Signaling", "KRAS Signaling Up")
prettier[[43L]] <- c("KRAS_SIGNALING_DN", "Signaling", "KRAS Signaling Down")
prettier[[44L]] <- c("MTORC1_SIGNALING", "Signaling", "mTORC1 Signaling")
prettier[[45L]] <- c("NOTCH_SIGNALING", "Signaling", "Notch Signaling")
prettier[[46L]] <- c("PI3K_AKT_MTOR_SIGNALING", "Signaling", "PI3K AKT mTOR Signaling")
prettier[[47L]] <- c("HEDGEHOG_SIGNALING", "Signaling", "Hedgehog Signaling")
prettier[[48L]] <- c("TGF_BETA_SIGNALING", "Signaling", "TGF Beta Signaling")
prettier[[49L]] <- c("TNFA_SIGNALING_VIA_NFKB", "Signaling", "TNFA Signaling via NFkB")
prettier[[50L]] <- c("WNT_BETA_CATENIN_SIGNALING", "Signaling", "WNT Beta Catenin Signaling")
prettier <- do.call(rbind, prettier) |> as.data.frame()
colnames(prettier) <- c("NAME", "CAT", "PrettyName")
extract_data <- function(fdr.limit) {
data_pos <- read.csv(params$pos_file, sep = "\t")
data_neg <- read.csv(params$neg_file, sep = "\t")
df <- rbind(data_pos, data_neg)
fdr <- df$FDR.q.val <= fdr.limit
df <- df[fdr, ]
df$type <- df$NES >= 0.0
df <- df[order(df$NES, decreasing = TRUE), ]
df$order <- 1L:nrow(df)
df$NAME <- gsub("HALLMARK_", "", df$NAME)
df$NAME <- gsub("_", " ", df$NAME)
idx <- match(df$NAME, gsub("_", " ", prettier$NAME))
df$Process <- prettier$CAT[idx]
df
}
plot_data <- function(data, name) {
col_jco <- pal_jco("default")(10)
colors <- c("DNA Damage" = col_jco[8],
"Metabolic" = col_jco[3],
"Immune" = col_jco[4],
"Proliferation" = col_jco[2],
"Signaling" = col_jco[10],
"Cellular Component" = col_jco[6],
"Development" = col_jco[5],
"Pathway" = col_jco[1])
q_labels <- format(data$FDR.q.val, digits = 3L, scientific = FALSE)
q_labels <- paste0("", q_labels)
text_younger <- grid::textGrob("\u2190 Younger", gp=grid::gpar(fontsize=6, fontface="bold"))
text_older <- grid::textGrob("Older \u2192", gp=grid::gpar(fontsize=6, fontface="bold"))
data_str <- readLines(params$cls_file)[-(1:2)]
num_tumors <- length(unlist(gregexpr("\t", data_str))) + 1
gg <- suppressWarnings(
ggplot(data, aes(NES, fill = Process)) +
geom_rect(aes(ymin = order - 0.4, ymax = order + 0.4, xmin = 0, xmax = NES)) +
labs(title = TeX(paste0(params$cancer_type, " Gene Set Analysis - ", name, " Phenotype ", "(n = ", num_tumors, ")"))) +
ylab("Hallmark Pathway") +
xlab("Normalized Enrichment Score") +
scale_y_continuous(breaks = 1:nrow(data), labels = data$NAME) +
scale_fill_manual(values = colors)+
annotation_custom(text_younger, xmax = -1, ymin = -4, ymax = -4) +
annotation_custom(text_older, xmin = 1, ymin = -4, ymax = -4) +
annotate(geom = "text",   # this annotation will likely be removed for publication
x = c(rep(-0.8, sum(data$NES > 0)),
rep( 0.8, sum(data$NES < 0))),
y = data$order,
label = q_labels,
color="black", size = 3) +
theme(axis.text.y = element_text(size = 9),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_blank(),
axis.line = element_line(colour = "black")))  +
coord_cartesian(clip="off")
ggsave("~/Library/CloudStorage/Box-Box/PROJECT 06023: MolClocks/Neuroblastoma_Paper/GSEA/TARGET/gsea_plot.png", plot = gg)
gg
}
for (i in 1L:1L) {
cat("\n")
cat("#### ", params$names[i], "\n")
cat("\n")
data <- extract_data(fdr.limit = params$fdr_limit)
plot_data(data = data, name = params$names[i]) |> print()
cat("\n")
cat("\n")
}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(ggsci)
library(latex2exp)
prettier <- list()
prettier[[1L]] <- c("APICAL_JUNCTION", "Cellular Component", "Apical Junction")
prettier[[2L]] <- c("APICAL_SURFACE", "Cellular Component", "Apical Surface")
prettier[[3L]] <- c("PEROXISOME", "Cellular Component", "Peroxisomes")
prettier[[4L]] <- c("ADIPOGENESIS", "Development", "Adipogenesis")
prettier[[5L]] <- c("ANGIOGENESIS", "Development", "Angiogenesis")
prettier[[6L]] <- c("EPITHELIAL_MESENCHYMAL_TRANSITION", "Development", "Epithelial Mesenchymal Transition")
prettier[[7L]] <- c("MYOGENESIS", "Development", "Myogenesis")
prettier[[8L]] <- c("SPERMATOGENESIS", "Development", "Spermatogenesis")
prettier[[9L]] <- c("PANCREAS_BETA_CELL", "Development", "Pancreas Beta Cell")
prettier[[10L]] <- c("DNA_REPAIR", "DNA Damage", "DNA Repair")
prettier[[11L]] <- c("UV_RESPONSE_DN", "DNA Damage", "UV Response Down")
prettier[[12L]] <- c("UV_RESPONSE_UP", "DNA Damage", "UV Response Up")
prettier[[13L]] <- c("ALLOGRAFT_REJECTION", "Immune", "Allograft Rejection")
prettier[[14L]] <- c("COAGULATION", "Immune", "Coagulation")
prettier[[15L]] <- c("COMPLEMENT", "Immune", "Complement")
prettier[[16L]] <- c("INTERFERON_ALPHA_RESPONSE", "Immune", "Interferon Alpha Response")
prettier[[17L]] <- c("INTERFERON_GAMMA_RESPONSE", "Immune", "Interferon Gamma Response")
prettier[[18L]] <- c("IL6_JAK_STAT3_SIGNALING", "Immune", "IL6 JAK STAT3 signaling")
prettier[[19L]] <- c("INFLAMMATORY_RESPONSE", "Immune", "Inflammatory Response")
prettier[[20L]] <- c("BILE_ACID_METABOLISM", "Metabolic", "Bile Acide Metabolism")
prettier[[21L]] <- c("CHOLESTEROL_HOMEOSTASIS", "Metabolic", "Cholesterol Homeostasis")
prettier[[22L]] <- c("FATTY_ACID_METABOLISM", "Metabolic", "Fatty Acid Metabolism")
prettier[[23L]] <- c("GLYCOLYSIS", "Metabolic", "Glycolysis")
prettier[[24L]] <- c("HEME_METABOLISM", "Metabolic", "Heme Metabolism")
prettier[[25L]] <- c("OXIDATIVE_PHOSPHORYLATION", "Metabolic", "Oxidative Phosphorylation")
prettier[[26L]] <- c("XENOBIOTIC_METABOLISM", "Metabolic", "Xenobiotic Metabolism")
prettier[[27L]] <- c("APOPTOSIS", "Pathway", "Apoptosis")
prettier[[28L]] <- c("HYPOXIA", "Pathway", "Hypoxia")
prettier[[29L]] <- c("PROTEIN_SECRETION", "Pathway", "Protein Secretion")
prettier[[30L]] <- c("UNFOLDED_PROTEIN_RESPONSE", "Pathway", "Unfolded Protein Response")
prettier[[31L]] <- c("REACTIVE_OXYGEN_SPECIES_PATHWAY", "Pathway", "Reactive Oxygen Species Pathway")
prettier[[32L]] <- c("E2F_TARGETS", "Proliferation", "E2F Targets")
prettier[[33L]] <- c("G2M_CHECKPOINT", "Proliferation", "G2/M Checkpoint")
prettier[[34L]] <- c("MYC_TARGETS_V1", "Proliferation", "MYC Targets Variant 1")
prettier[[35L]] <- c("MYC_TARGETS_V2", "Proliferation", "MYC Targets Variant 2")
prettier[[36L]] <- c("P53_PATHWAY", "Proliferation", "p53 Pathway")
prettier[[37L]] <- c("MITOTIC_SPINDLE", "Proliferation", "Mitotic Spindle")
prettier[[38L]] <- c("ANDROGEN_RESPONSE", "Signaling", "Androgen Response")
prettier[[39L]] <- c("ESTROGEN_RESPONSE_EARLY", "Signaling", "Estrogen Response Early")
prettier[[40L]] <- c("ESTROGEN_RESPONSE_LATE", "Signaling", "Estrogen Response Late")
prettier[[41L]] <- c("IL2_STAT5_SIGNALING", "Signaling", "IL2 JAK STAT5 Signaling")
prettier[[42L]] <- c("KRAS_SIGNALING_UP", "Signaling", "KRAS Signaling Up")
prettier[[43L]] <- c("KRAS_SIGNALING_DN", "Signaling", "KRAS Signaling Down")
prettier[[44L]] <- c("MTORC1_SIGNALING", "Signaling", "mTORC1 Signaling")
prettier[[45L]] <- c("NOTCH_SIGNALING", "Signaling", "Notch Signaling")
prettier[[46L]] <- c("PI3K_AKT_MTOR_SIGNALING", "Signaling", "PI3K AKT mTOR Signaling")
prettier[[47L]] <- c("HEDGEHOG_SIGNALING", "Signaling", "Hedgehog Signaling")
prettier[[48L]] <- c("TGF_BETA_SIGNALING", "Signaling", "TGF Beta Signaling")
prettier[[49L]] <- c("TNFA_SIGNALING_VIA_NFKB", "Signaling", "TNFA Signaling via NFkB")
prettier[[50L]] <- c("WNT_BETA_CATENIN_SIGNALING", "Signaling", "WNT Beta Catenin Signaling")
prettier <- do.call(rbind, prettier) |> as.data.frame()
colnames(prettier) <- c("NAME", "CAT", "PrettyName")
extract_data <- function(fdr.limit) {
data_pos <- read.csv(params$pos_file, sep = "\t")
data_neg <- read.csv(params$neg_file, sep = "\t")
df <- rbind(data_pos, data_neg)
fdr <- df$FDR.q.val <= fdr.limit
df <- df[fdr, ]
df$type <- df$NES >= 0.0
df <- df[order(df$NES, decreasing = TRUE), ]
df$order <- 1L:nrow(df)
df$NAME <- gsub("HALLMARK_", "", df$NAME)
df$NAME <- gsub("_", " ", df$NAME)
idx <- match(df$NAME, gsub("_", " ", prettier$NAME))
df$Process <- prettier$CAT[idx]
df
}
plot_data <- function(data, name) {
col_jco <- pal_jco("default")(10)
colors <- c("DNA Damage" = col_jco[8],
"Metabolic" = col_jco[3],
"Immune" = col_jco[4],
"Proliferation" = col_jco[2],
"Signaling" = col_jco[10],
"Cellular Component" = col_jco[6],
"Development" = col_jco[5],
"Pathway" = col_jco[1])
q_labels <- format(data$FDR.q.val, digits = 3L, scientific = FALSE)
q_labels <- paste0("", q_labels)
text_younger <- grid::textGrob("\u2190 Younger", gp=grid::gpar(fontsize=6, fontface="bold"))
text_older <- grid::textGrob("Older \u2192", gp=grid::gpar(fontsize=6, fontface="bold"))
data_str <- readLines(params$cls_file)[-(1:2)] + 18
num_tumors <- length(unlist(gregexpr("\t", data_str))) + 1
gg <- suppressWarnings(
ggplot(data, aes(NES, fill = Process)) +
geom_rect(aes(ymin = order - 0.4, ymax = order + 0.4, xmin = 0, xmax = NES)) +
labs(title = TeX(paste0(params$cancer_type, " Gene Set Analysis - ", name, " Phenotype ", "(n = ", num_tumors, ")"))) +
ylab("Hallmark Pathway") +
xlab("Normalized Enrichment Score") +
scale_y_continuous(breaks = 1:nrow(data), labels = data$NAME) +
scale_fill_manual(values = colors)+
annotation_custom(text_younger, xmax = -1, ymin = -4, ymax = -4) +
annotation_custom(text_older, xmin = 1, ymin = -4, ymax = -4) +
annotate(geom = "text",   # this annotation will likely be removed for publication
x = c(rep(-0.8, sum(data$NES > 0)),
rep( 0.8, sum(data$NES < 0))),
y = data$order,
label = q_labels,
color="black", size = 3) +
theme(axis.text.y = element_text(size = 9),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_blank(),
axis.line = element_line(colour = "black")))  +
coord_cartesian(clip="off")
ggsave("~/Library/CloudStorage/Box-Box/PROJECT 06023: MolClocks/Neuroblastoma_Paper/GSEA/TARGET/gsea_plot.png", plot = gg)
gg
}
for (i in 1L:1L) {
cat("\n")
cat("#### ", params$names[i], "\n")
cat("\n")
data <- extract_data(fdr.limit = params$fdr_limit)
plot_data(data = data, name = params$names[i]) |> print()
cat("\n")
cat("\n")
}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(ggsci)
library(latex2exp)
prettier <- list()
prettier[[1L]] <- c("APICAL_JUNCTION", "Cellular Component", "Apical Junction")
prettier[[2L]] <- c("APICAL_SURFACE", "Cellular Component", "Apical Surface")
prettier[[3L]] <- c("PEROXISOME", "Cellular Component", "Peroxisomes")
prettier[[4L]] <- c("ADIPOGENESIS", "Development", "Adipogenesis")
prettier[[5L]] <- c("ANGIOGENESIS", "Development", "Angiogenesis")
prettier[[6L]] <- c("EPITHELIAL_MESENCHYMAL_TRANSITION", "Development", "Epithelial Mesenchymal Transition")
prettier[[7L]] <- c("MYOGENESIS", "Development", "Myogenesis")
prettier[[8L]] <- c("SPERMATOGENESIS", "Development", "Spermatogenesis")
prettier[[9L]] <- c("PANCREAS_BETA_CELL", "Development", "Pancreas Beta Cell")
prettier[[10L]] <- c("DNA_REPAIR", "DNA Damage", "DNA Repair")
prettier[[11L]] <- c("UV_RESPONSE_DN", "DNA Damage", "UV Response Down")
prettier[[12L]] <- c("UV_RESPONSE_UP", "DNA Damage", "UV Response Up")
prettier[[13L]] <- c("ALLOGRAFT_REJECTION", "Immune", "Allograft Rejection")
prettier[[14L]] <- c("COAGULATION", "Immune", "Coagulation")
prettier[[15L]] <- c("COMPLEMENT", "Immune", "Complement")
prettier[[16L]] <- c("INTERFERON_ALPHA_RESPONSE", "Immune", "Interferon Alpha Response")
prettier[[17L]] <- c("INTERFERON_GAMMA_RESPONSE", "Immune", "Interferon Gamma Response")
prettier[[18L]] <- c("IL6_JAK_STAT3_SIGNALING", "Immune", "IL6 JAK STAT3 signaling")
prettier[[19L]] <- c("INFLAMMATORY_RESPONSE", "Immune", "Inflammatory Response")
prettier[[20L]] <- c("BILE_ACID_METABOLISM", "Metabolic", "Bile Acide Metabolism")
prettier[[21L]] <- c("CHOLESTEROL_HOMEOSTASIS", "Metabolic", "Cholesterol Homeostasis")
prettier[[22L]] <- c("FATTY_ACID_METABOLISM", "Metabolic", "Fatty Acid Metabolism")
prettier[[23L]] <- c("GLYCOLYSIS", "Metabolic", "Glycolysis")
prettier[[24L]] <- c("HEME_METABOLISM", "Metabolic", "Heme Metabolism")
prettier[[25L]] <- c("OXIDATIVE_PHOSPHORYLATION", "Metabolic", "Oxidative Phosphorylation")
prettier[[26L]] <- c("XENOBIOTIC_METABOLISM", "Metabolic", "Xenobiotic Metabolism")
prettier[[27L]] <- c("APOPTOSIS", "Pathway", "Apoptosis")
prettier[[28L]] <- c("HYPOXIA", "Pathway", "Hypoxia")
prettier[[29L]] <- c("PROTEIN_SECRETION", "Pathway", "Protein Secretion")
prettier[[30L]] <- c("UNFOLDED_PROTEIN_RESPONSE", "Pathway", "Unfolded Protein Response")
prettier[[31L]] <- c("REACTIVE_OXYGEN_SPECIES_PATHWAY", "Pathway", "Reactive Oxygen Species Pathway")
prettier[[32L]] <- c("E2F_TARGETS", "Proliferation", "E2F Targets")
prettier[[33L]] <- c("G2M_CHECKPOINT", "Proliferation", "G2/M Checkpoint")
prettier[[34L]] <- c("MYC_TARGETS_V1", "Proliferation", "MYC Targets Variant 1")
prettier[[35L]] <- c("MYC_TARGETS_V2", "Proliferation", "MYC Targets Variant 2")
prettier[[36L]] <- c("P53_PATHWAY", "Proliferation", "p53 Pathway")
prettier[[37L]] <- c("MITOTIC_SPINDLE", "Proliferation", "Mitotic Spindle")
prettier[[38L]] <- c("ANDROGEN_RESPONSE", "Signaling", "Androgen Response")
prettier[[39L]] <- c("ESTROGEN_RESPONSE_EARLY", "Signaling", "Estrogen Response Early")
prettier[[40L]] <- c("ESTROGEN_RESPONSE_LATE", "Signaling", "Estrogen Response Late")
prettier[[41L]] <- c("IL2_STAT5_SIGNALING", "Signaling", "IL2 JAK STAT5 Signaling")
prettier[[42L]] <- c("KRAS_SIGNALING_UP", "Signaling", "KRAS Signaling Up")
prettier[[43L]] <- c("KRAS_SIGNALING_DN", "Signaling", "KRAS Signaling Down")
prettier[[44L]] <- c("MTORC1_SIGNALING", "Signaling", "mTORC1 Signaling")
prettier[[45L]] <- c("NOTCH_SIGNALING", "Signaling", "Notch Signaling")
prettier[[46L]] <- c("PI3K_AKT_MTOR_SIGNALING", "Signaling", "PI3K AKT mTOR Signaling")
prettier[[47L]] <- c("HEDGEHOG_SIGNALING", "Signaling", "Hedgehog Signaling")
prettier[[48L]] <- c("TGF_BETA_SIGNALING", "Signaling", "TGF Beta Signaling")
prettier[[49L]] <- c("TNFA_SIGNALING_VIA_NFKB", "Signaling", "TNFA Signaling via NFkB")
prettier[[50L]] <- c("WNT_BETA_CATENIN_SIGNALING", "Signaling", "WNT Beta Catenin Signaling")
prettier <- do.call(rbind, prettier) |> as.data.frame()
colnames(prettier) <- c("NAME", "CAT", "PrettyName")
extract_data <- function(fdr.limit) {
data_pos <- read.csv(params$pos_file, sep = "\t")
data_neg <- read.csv(params$neg_file, sep = "\t")
df <- rbind(data_pos, data_neg)
fdr <- df$FDR.q.val <= fdr.limit
df <- df[fdr, ]
df$type <- df$NES >= 0.0
df <- df[order(df$NES, decreasing = TRUE), ]
df$order <- 1L:nrow(df)
df$NAME <- gsub("HALLMARK_", "", df$NAME)
df$NAME <- gsub("_", " ", df$NAME)
idx <- match(df$NAME, gsub("_", " ", prettier$NAME))
df$Process <- prettier$CAT[idx]
df
}
plot_data <- function(data, name) {
col_jco <- pal_jco("default")(10)
colors <- c("DNA Damage" = col_jco[8],
"Metabolic" = col_jco[3],
"Immune" = col_jco[4],
"Proliferation" = col_jco[2],
"Signaling" = col_jco[10],
"Cellular Component" = col_jco[6],
"Development" = col_jco[5],
"Pathway" = col_jco[1])
q_labels <- format(data$FDR.q.val, digits = 3L, scientific = FALSE)
q_labels <- paste0("", q_labels)
text_younger <- grid::textGrob("\u2190 Younger", gp=grid::gpar(fontsize=6, fontface="bold"))
text_older <- grid::textGrob("Older \u2192", gp=grid::gpar(fontsize=6, fontface="bold"))
data_str <- readLines(params$cls_file)[-(1:2)]
num_tumors <- length(unlist(gregexpr("\t", data_str))) + 1 + 18
gg <- suppressWarnings(
ggplot(data, aes(NES, fill = Process)) +
geom_rect(aes(ymin = order - 0.4, ymax = order + 0.4, xmin = 0, xmax = NES)) +
labs(title = TeX(paste0(params$cancer_type, " Gene Set Analysis - ", name, " Phenotype ", "(n = ", num_tumors, ")"))) +
ylab("Hallmark Pathway") +
xlab("Normalized Enrichment Score") +
scale_y_continuous(breaks = 1:nrow(data), labels = data$NAME) +
scale_fill_manual(values = colors)+
annotation_custom(text_younger, xmax = -1, ymin = -4, ymax = -4) +
annotation_custom(text_older, xmin = 1, ymin = -4, ymax = -4) +
annotate(geom = "text",   # this annotation will likely be removed for publication
x = c(rep(-0.8, sum(data$NES > 0)),
rep( 0.8, sum(data$NES < 0))),
y = data$order,
label = q_labels,
color="black", size = 3) +
theme(axis.text.y = element_text(size = 9),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_blank(),
axis.line = element_line(colour = "black")))  +
coord_cartesian(clip="off")
ggsave("~/Library/CloudStorage/Box-Box/PROJECT 06023: MolClocks/Neuroblastoma_Paper/GSEA/TARGET/gsea_plot.png", plot = gg)
gg
}
for (i in 1L:1L) {
cat("\n")
cat("#### ", params$names[i], "\n")
cat("\n")
data <- extract_data(fdr.limit = params$fdr_limit)
plot_data(data = data, name = params$names[i]) |> print()
cat("\n")
cat("\n")
}
